{% extends "snapp/base.html" %}

{% block head %}
{% endblock %}
{% block content %}
    <script type="text/javascript">

        var localStoreKey = document.URL;
        function saveDraft() {
            var formData = $('#awesome > p > :input').serializeArray();
            localStorage[localStoreKey] = JSON.stringify(formData);
            showAlertTemporarily();
        }

        var populateWithLocalData = function () {
            var draftData = JSON.parse(localStorage.getItem(localStoreKey));

            $('#awesome > p > :input').each(function (inputIdx, inputField) {
                $(draftData).each(function (draftDataIdx, draftDataField) {
                    for (idx in draftData) {
                        if (inputField.name === draftDataField.name) {
                            if (inputField.type === "checkbox") {
                                $(inputField).prop('checked', true);
                            }
                            inputField.value = draftDataField.value;
                        }
                    }
                });
            });
        };

        var groupFieldSets = function () {

            fieldsets = {}

            $('#awesome > p > :input').each(function (inputIdx, inputField) {
                if (inputField.dataset.fieldset) {
                    fieldsets[inputField.dataset.fieldset] = fieldsets[inputField.dataset.fieldset] || $("<fieldset><legend>" + inputField.dataset.fieldset + "</legend></fieldset>")
                    fieldsets[inputField.dataset.fieldset].append($(inputField).parent())
                }
            });
            $.each(fieldsets, function (key, value) {
                {#                $("#awesome").append(value)#}
                value.insertBefore($("input[type='submit']"))
                {#                value.insertBefore($("#awesome :last-child"))#}
                console.log(key + ": " + value);
            });
        };
        
        // todo: any sensitive data?
        // todo: dont notify if save failed due to invalid data

        $(document).ready(function () {

            $('#awesome > p > :input').focusout(function () {
                saveDraft();
            })

            populateWithLocalData();

            $(".alert").hide();
            $(".alert").alert();
            $("form li").addClass("form-group");
            $("select").addClass("form-control");

            groupFieldSets();
        });
    </script>
    <h1>{{ form.title }}</h1>

    {% if form.intro %}
        <p>{{ form.intro }}</p>
    {% endif %}
    <form id="awesome" action="{{ form.get_absolute_url }}" method="post"
          {% if form_for_form.is_multipart %}enctype="multipart/form-data"{% endif %}>
        {% csrf_token %}
        {{ form_for_form.as_p }}
        <div style="clear:left;">&nbsp;</div>
        <input type="submit" value="{{ form.button_text }}">
    </form>
{% endblock %}
